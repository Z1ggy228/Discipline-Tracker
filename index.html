<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Discipline Tracker</title>
    <style>
      :root {
        --bg: #0b0f14;
        --card: #111827;
        --card2: #0f172a;
        --text: #e5e7eb;
        --muted: #9ca3af;
        --accent: #60a5fa;
        --good: #34d399;
        --bad: #fb7185;
        --warn: #fbbf24;
        --line: #243244;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
        --radius: 16px;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
        background: radial-gradient(1000px 600px at 20% -10%, rgba(96, 165, 250, 0.18), transparent 60%),
          radial-gradient(900px 500px at 90% 10%, rgba(52, 211, 153, 0.12), transparent 55%), var(--bg);
        color: var(--text);
      }
      .wrap {
        max-width: 1100px;
        margin: 0 auto;
        padding: 22px;
      }
      header {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: flex-end;
        justify-content: space-between;
        margin-bottom: 14px;
      }
      h1 {
        font-size: 20px;
        margin: 0;
        letter-spacing: 0.2px;
      }
      .sub {
        color: var(--muted);
        font-size: 13px;
        margin-top: 4px;
      }
      .row {
        display: grid;
        grid-template-columns: 1.2fr 0.8fr;
        gap: 14px;
      }
      @media (max-width: 980px) {
        .row {
          grid-template-columns: 1fr;
        }
      }
      .card {
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0.01));
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 14px;
      }
      .card h2 {
        font-size: 14px;
        margin: 0 0 10px;
        color: #cbd5e1;
        font-weight: 600;
      }
      .grid2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      @media (max-width: 560px) {
        .grid2 {
          grid-template-columns: 1fr;
        }
      }
      label {
        display: block;
        color: var(--muted);
        font-size: 12px;
        margin: 0 0 6px;
      }
      input[type='time'],
      input[type='date'],
      input[type='text'],
      input[type='number'],
      textarea,
      select {
        width: 100%;
        background: rgba(15, 23, 42, 0.55);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: var(--text);
        padding: 10px 10px;
        border-radius: 12px;
        outline: none;
      }
      textarea {
        min-height: 86px;
        resize: vertical;
      }
      .btns {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      button {
        background: rgba(96, 165, 250, 0.14);
        border: 1px solid rgba(96, 165, 250, 0.25);
        color: var(--text);
        padding: 9px 12px;
        border-radius: 12px;
        cursor: pointer;
        transition: transform 0.05s ease, background 0.2s ease;
        font-weight: 600;
        font-size: 13px;
      }
      button:hover {
        background: rgba(96, 165, 250, 0.22);
      }
      button:active {
        transform: translateY(1px);
      }
      .ghost {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .danger {
        background: rgba(251, 113, 133, 0.14);
        border-color: rgba(251, 113, 133, 0.3);
      }
      .good {
        background: rgba(52, 211, 153, 0.12);
        border-color: rgba(52, 211, 153, 0.25);
      }
      .tag {
        display: inline-flex;
        align-items: center;
        gap: 7px;
        padding: 7px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.06);
        font-size: 12px;
        color: var(--muted);
      }
      .tag b {
        color: var(--text);
        font-weight: 700;
      }
      .tags {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .hr {
        height: 1px;
        background: rgba(255, 255, 255, 0.08);
        margin: 12px 0;
      }
      .todayHead {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        flex-wrap: wrap;
      }
      .big {
        font-size: 18px;
        font-weight: 800;
        letter-spacing: 0.3px;
      }
      .muted {
        color: var(--muted);
      }
      .todoItem {
        display: flex;
        gap: 10px;
        align-items: flex-start;
        padding: 10px;
        border-radius: 14px;
        background: rgba(15, 23, 42, 0.35);
        border: 1px solid rgba(255, 255, 255, 0.06);
        margin-bottom: 8px;
      }
      .todoItem input[type='checkbox'] {
        transform: translateY(2px);
        width: 18px;
        height: 18px;
      }
      .todoText {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 3px;
      }
      .todoText .title {
        font-weight: 700;
        font-size: 13px;
      }
      .todoText .note {
        font-size: 12px;
        color: var(--muted);
      }
      .miniBtn {
        padding: 7px 10px;
        border-radius: 10px;
        font-size: 12px;
        background: rgba(255, 255, 255, 0.06);
        border-color: rgba(255, 255, 255, 0.1);
      }
      .kpi {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
      }
      @media (max-width: 980px) {
        .kpi {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      .kpiBox {
        padding: 12px;
        border-radius: 14px;
        background: rgba(15, 23, 42, 0.35);
        border: 1px solid rgba(255, 255, 255, 0.06);
      }
      .kpiBox .v {
        font-size: 20px;
        font-weight: 900;
      }
      .kpiBox .t {
        font-size: 12px;
        color: var(--muted);
        margin-top: 3px;
      }
      .pomodoro {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        align-items: center;
      }
      @media (max-width: 560px) {
        .pomodoro {
          grid-template-columns: 1fr;
        }
      }
      .timer {
        font-size: 34px;
        font-weight: 900;
        letter-spacing: 1px;
        padding: 14px;
        border-radius: 14px;
        background: rgba(15, 23, 42, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.06);
        text-align: center;
      }
      .pill {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
        justify-content: flex-end;
      }
      .small {
        font-size: 12px;
        color: var(--muted);
      }
      .ok {
        color: var(--good);
      }
      .no {
        color: var(--bad);
      }
      .warn {
        color: var(--warn);
      }
      footer {
        margin-top: 14px;
        color: var(--muted);
        font-size: 12px;
      }
      .link {
        color: #93c5fd;
        text-decoration: none;
      }
      .link:hover {
        text-decoration: underline;
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <header>
        <div>
          <h1>Discipline Tracker</h1>
          <div class="sub">–†–µ–∂–∏–º ‚Üí 1 –∑–∞–¥–∞—á–∞ ‚Üí 4 —á–∞—Å–∞. –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ (localStorage).</div>
        </div>
        <div class="tags" id="headerTags"></div>
      </header>

      <div class="row">
        <!-- LEFT -->
        <div class="card">
          <div class="todayHead">
            <div>
              <div class="muted" style="font-size: 12px">–î–µ–Ω—å</div>
              <div class="big" id="todayLabel">‚Äî</div>
            </div>
            <div class="pill">
              <span class="tag"><span>–°—Ç–∞—Ä—Ç —Ä–∞–±–æ—Ç—ã:</span> <b id="kWorkStart">‚Äî</b></span>
              <span class="tag"><span>–§–æ–∫—É—Å:</span> <b id="kFocus">‚Äî</b></span>
            </div>
          </div>

          <div class="hr"></div>

          <div class="grid2">
            <div>
              <label for="focusTask">–ì–ª–∞–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ –¥–Ω—è (1 —à—Ç—É–∫–∞)</label>
              <input id="focusTask" type="text" placeholder="–ù–∞–ø—Ä: –¥–æ–¥–µ–ª–∞—Ç—å –∞–¥–∞–ø—Ç–∏–≤ –≤ Tilda" />
            </div>
            <div>
              <label for="workMinutesGoal">–¶–µ–ª—å –ø–æ —Ä–∞–±–æ—Ç–µ (–º–∏–Ω—É—Ç—ã)</label>
              <input id="workMinutesGoal" type="number" min="60" step="10" />
              <div class="small" style="margin-top: 6px">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 240 –º–∏–Ω—É—Ç = 4 —á–∞—Å–∞.</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="grid2">
            <div>
              <label for="notes">–ó–∞–º–µ—Ç–∫–∏ (—á—Ç–æ –º–µ—à–∞–ª–æ / —á—Ç–æ –ø–æ–º–æ–≥–ª–æ)</label>
              <textarea id="notes" placeholder="–ö–æ—Ä–æ—Ç–∫–æ: —á—Ç–æ –±—ã–ª–æ —Å–ª–æ–∂–Ω—ã–º, —á—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–ª–æ"></textarea>
            </div>

            <div>
              <h2 style="margin: 0 0 10px">–î–Ω–µ–≤–Ω–æ–π —á–µ–∫–ª–∏—Å—Ç</h2>
              <div id="todoList"></div>

              <div class="grid2" style="margin-top: 10px">
                <div>
                  <label for="newTodoTitle">–î–æ–±–∞–≤–∏—Ç—å –ø—É–Ω–∫—Ç</label>
                  <input id="newTodoTitle" type="text" placeholder="–ù–∞–ø—Ä: 4 –ø–æ–º–æ–¥–æ—Ä–æ" />
                </div>
                <div style="display: flex; align-items: flex-end; gap: 8px">
                  <button class="good" id="addTodoBtn" style="width: 100%">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
              </div>

              <div class="btns" style="margin-top: 10px">
                <button class="ghost" id="copyYesterdayBtn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —á–µ–∫–ª–∏—Å—Ç —Å–æ –≤—á–µ—Ä–∞</button>
                <button class="danger" id="resetTodayBtn">–°–±—Ä–æ—Å–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å</button>
              </div>
            </div>
          </div>
        </div>

        <!-- RIGHT -->
        <div>
          <div class="card">
            <h2>–†–µ–∂–∏–º</h2>
            <div class="grid2">
              <div>
                <label for="sleepTime">–õ–æ–∂—É—Å—å (–ø–ª–∞–Ω)</label>
                <input id="sleepTime" type="time" />
              </div>
              <div>
                <label for="wakeTime">–í—Å—Ç–∞—é (–ø–ª–∞–Ω)</label>
                <input id="wakeTime" type="time" />
              </div>
              <div>
                <label for="workStartTime">–°–∞–∂—É—Å—å –∑–∞ –∫–æ–º–ø (–ø–ª–∞–Ω)</label>
                <input id="workStartTime" type="time" />
              </div>
              <div>
                <label for="startDate">–°—Ç–∞—Ä—Ç ‚Äú–ø—É—Ç–∏ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã‚Äù</label>
                <input id="startDate" type="date" />
              </div>
            </div>

            <div class="hr"></div>

            <div class="kpi">
              <div class="kpiBox">
                <div class="v" id="kpiStreak">‚Äî</div>
                <div class="t">–°–µ—Ä–∏—è ‚Äú–¥–µ–Ω—å –∑–∞—Å—á–∏—Ç–∞–Ω‚Äù</div>
              </div>
              <div class="kpiBox">
                <div class="v" id="kpiDaysDone">‚Äî</div>
                <div class="t">–ó–∞—Å—á–∏—Ç–∞–Ω–æ –¥–Ω–µ–π (–∑–∞ 30)</div>
              </div>
              <div class="kpiBox">
                <div class="v" id="kpiWorkMin">‚Äî</div>
                <div class="t">–†–∞–±–æ—Ç–∞ —Å–µ–≥–æ–¥–Ω—è (–º–∏–Ω)</div>
              </div>
              <div class="kpiBox">
                <div class="v" id="kpiSleepWin">‚Äî</div>
                <div class="t">–†–µ–∂–∏–º (–æ—Ü–µ–Ω–∫–∞)</div>
              </div>
            </div>

            <div class="hr"></div>

            <h2 style="margin-top: 0">–ü–æ–º–æ–¥–æ—Ä–æ</h2>
            <div class="pomodoro">
              <div class="timer" id="timerLabel">25:00</div>
              <div>
                <div class="grid2">
                  <div>
                    <label for="pomodoroWork">–†–∞–±–æ—Ç–∞ (–º–∏–Ω)</label>
                    <input id="pomodoroWork" type="number" min="10" max="90" step="1" />
                  </div>
                  <div>
                    <label for="pomodoroBreak">–ü–µ—Ä–µ—Ä—ã–≤ (–º–∏–Ω)</label>
                    <input id="pomodoroBreak" type="number" min="3" max="30" step="1" />
                  </div>
                </div>
                <div class="btns" style="margin-top: 10px; justify-content: flex-end">
                  <button class="good" id="startPomodoroBtn">–°—Ç–∞—Ä—Ç</button>
                  <button class="ghost" id="pausePomodoroBtn">–ü–∞—É–∑–∞</button>
                  <button class="danger" id="stopPomodoroBtn">–°—Ç–æ–ø</button>
                </div>
                <div class="small" style="margin-top: 10px">
                  –ó–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è <b>—Ç–æ–ª—å–∫–æ</b> —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è (work-—Å–µ—Å—Å–∏–∏) ‚Üí –∏–¥—ë—Ç –≤ ‚Äú–†–∞–±–æ—Ç–∞ —Å–µ–≥–æ–¥–Ω—è‚Äù.
                </div>
              </div>
            </div>

            <div class="hr"></div>

            <div class="btns">
              <button id="markDayDoneBtn" class="good">–ó–∞—Å—á–∏—Ç–∞—Ç—å –¥–µ–Ω—å</button>
              <button id="exportBtn" class="ghost">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
              <button id="importBtn" class="ghost">–ò–º–ø–æ—Ä—Ç JSON</button>
              <button id="clearAllBtn" class="danger">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
            </div>
            <input id="importFile" type="file" accept="application/json" style="display: none" />
          </div>

          <div class="card" style="margin-top: 14px">
            <h2>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 14 –¥–Ω–µ–π</h2>
            <div id="history"></div>
          </div>
        </div>
      </div>

      <footer>
        –ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî –º–æ–≥—É –¥–æ–ø–∏–ª–∏—Ç—å: –∫–∞–ª–µ–Ω–¥–∞—Ä—å, –≥—Ä–∞—Ñ–∏–∫–∏, ‚Äú—à—Ç—Ä–∞—Ñ –∑–∞ —Å—Ä—ã–≤ —Ä–µ–∂–∏–º–∞‚Äù, –∞–≤—Ç–æ-—Ü–µ–ª—å –Ω–∞ 6/7/8 —á–∞—Å–æ–≤.
        <br />–ú–æ—Ç–∏–≤–∞—Ü–∏—è: –ü—Ö—É–∫–µ—Ç –±–ª–∏–∂–µ –∫–∞–∂–¥—ã–π —Ä–∞–∑, –∫–æ–≥–¥–∞ —Ç—ã –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ—à—å –¥–µ–Ω—å üå¥
      </footer>
    </div>

    <script>
      (() => {
        const LS_KEY = 'discipline_tracker_v1';

        const $ = id => document.getElementById(id);

        const els = {
          headerTags: $('headerTags'),
          todayLabel: $('todayLabel'),
          kWorkStart: $('kWorkStart'),
          kFocus: $('kFocus'),
          focusTask: $('focusTask'),
          workMinutesGoal: $('workMinutesGoal'),
          notes: $('notes'),
          todoList: $('todoList'),
          newTodoTitle: $('newTodoTitle'),
          addTodoBtn: $('addTodoBtn'),
          copyYesterdayBtn: $('copyYesterdayBtn'),
          resetTodayBtn: $('resetTodayBtn'),

          sleepTime: $('sleepTime'),
          wakeTime: $('wakeTime'),
          workStartTime: $('workStartTime'),
          startDate: $('startDate'),

          kpiStreak: $('kpiStreak'),
          kpiDaysDone: $('kpiDaysDone'),
          kpiWorkMin: $('kpiWorkMin'),
          kpiSleepWin: $('kpiSleepWin'),

          timerLabel: $('timerLabel'),
          pomodoroWork: $('pomodoroWork'),
          pomodoroBreak: $('pomodoroBreak'),
          startPomodoroBtn: $('startPomodoroBtn'),
          pausePomodoroBtn: $('pausePomodoroBtn'),
          stopPomodoroBtn: $('stopPomodoroBtn'),

          markDayDoneBtn: $('markDayDoneBtn'),
          exportBtn: $('exportBtn'),
          importBtn: $('importBtn'),
          importFile: $('importFile'),
          clearAllBtn: $('clearAllBtn'),

          history: $('history'),
        };

        const pad2 = n => String(n).padStart(2, '0');
        const todayISO = () => new Date().toISOString().slice(0, 10);
        const dateLabel = iso => {
          const d = new Date(iso + 'T00:00:00');
          return d.toLocaleDateString('ru-RU', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        };

        const defaultState = () => ({
          settings: {
            sleepTime: '00:30',
            wakeTime: '08:30',
            workStartTime: '10:00',
            startDate: '2026-01-14',
            pomodoroWork: 25,
            pomodoroBreak: 5,
            workMinutesGoal: 240,
          },
          days: {
            // [iso]: { focusTask, notes, todos:[{id,title,done}], workMinutes, done:boolean, markedAtISO }
          },
        });

        const load = () => {
          try {
            const raw = localStorage.getItem(LS_KEY);
            if (!raw) return defaultState();
            const data = JSON.parse(raw);
            // minimal sanity
            if (!data || typeof data !== 'object' || !data.settings || !data.days) return defaultState();
            return data;
          } catch (e) {
            return defaultState();
          }
        };

        const save = () => localStorage.setItem(LS_KEY, JSON.stringify(state));

        let state = load();

        const getDay = iso => {
          if (!state.days[iso]) {
            state.days[iso] = {
              focusTask: '',
              notes: '',
              todos: [
                { id: crypto.randomUUID(), title: '–°–µ–ª –∑–∞ –∫–æ–º–ø –≤–æ–≤—Ä–µ–º—è', done: false },
                { id: crypto.randomUUID(), title: '1 –≥–ª–∞–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ (–¥–≤–∏–≥–∞–ª)', done: false },
                { id: crypto.randomUUID(), title: '4 —á–∞—Å–∞ —Ñ–æ–∫—É—Å–∞ (–∏–ª–∏ 240 –º–∏–Ω)', done: false },
              ],
              workMinutes: 0,
              done: false,
              markedAtISO: '',
            };
            save();
          }
          return state.days[iso];
        };

        const isTimeClose = (planned, actual) => {
          // returns diff minutes
          const [ph, pm] = planned.split(':').map(Number);
          const [ah, am] = actual.split(':').map(Number);
          return Math.abs(ph * 60 + pm - (ah * 60 + am));
        };

        // --- Pomodoro ---
        let pom = {
          running: false,
          paused: false,
          mode: 'work', // work | break
          remainingSec: 25 * 60,
          intervalId: null,
        };

        const formatMMSS = sec => {
          const m = Math.floor(sec / 60);
          const s = sec % 60;
          return `${pad2(m)}:${pad2(s)}`;
        };

        const setTimerLabel = () => (els.timerLabel.textContent = formatMMSS(pom.remainingSec));

        const stopPomodoro = () => {
          pom.running = false;
          pom.paused = false;
          pom.mode = 'work';
          pom.remainingSec = (Number(state.settings.pomodoroWork) || 25) * 60;
          if (pom.intervalId) clearInterval(pom.intervalId);
          pom.intervalId = null;
          setTimerLabel();
          renderKPIs();
        };

        const tickPomodoro = () => {
          if (!pom.running || pom.paused) return;
          pom.remainingSec -= 1;

          // count work time
          if (pom.mode === 'work') {
            const iso = todayISO();
            const day = getDay(iso);
            day.workMinutes += 1 / 60;
            // keep as integer minutes later
          }

          if (pom.remainingSec <= 0) {
            // switch mode
            if (pom.mode === 'work') {
              pom.mode = 'break';
              pom.remainingSec = (Number(state.settings.pomodoroBreak) || 5) * 60;
            } else {
              pom.mode = 'work';
              pom.remainingSec = (Number(state.settings.pomodoroWork) || 25) * 60;
            }
          }
          setTimerLabel();
          renderKPIs();
          save();
        };

        const startPomodoro = () => {
          if (!pom.running) {
            pom.running = true;
            pom.paused = false;
            if (!pom.intervalId) {
              pom.intervalId = setInterval(tickPomodoro, 1000);
            }
          } else {
            pom.paused = false;
          }
        };

        const pausePomodoro = () => {
          if (pom.running) pom.paused = true;
        };

        // --- UI ---
        const renderHeaderTags = () => {
          const iso = todayISO();
          const day = getDay(iso);

          const goal = Number(state.settings.workMinutesGoal) || 240;
          const workMin = Math.round(day.workMinutes);

          const doneTxt = day.done ? '–¥–µ–Ω—å –∑–∞—Å—á–∏—Ç–∞–Ω' : '–Ω–µ –∑–∞—Å—á–∏—Ç–∞–Ω';
          const doneCls = day.done ? 'ok' : 'no';

          const ratio = Math.min(100, Math.round((workMin / goal) * 100));
          const ratioCls = ratio >= 100 ? 'ok' : ratio >= 60 ? 'warn' : 'no';

          els.headerTags.innerHTML = `
      <span class="tag"><span>–°–µ–≥–æ–¥–Ω—è:</span> <b class="${doneCls}">${doneTxt}</b></span>
      <span class="tag"><span>–§–æ–∫—É—Å:</span> <b>${(day.focusTask || '‚Äî').slice(0, 24)}</b></span>
      <span class="tag"><span>–†–∞–±–æ—Ç–∞:</span> <b class="${ratioCls}">${workMin}/${goal} –º–∏–Ω (${ratio}%)</b></span>
      <span class="tag"><span>–†–µ–∂–∏–º:</span> <b>${state.settings.sleepTime} ‚Üí ${state.settings.wakeTime}</b></span>
    `;
        };

        const renderToday = () => {
          const iso = todayISO();
          const day = getDay(iso);

          els.todayLabel.textContent = dateLabel(iso);
          els.kWorkStart.textContent = state.settings.workStartTime || '‚Äî';
          els.kFocus.textContent = day.focusTask ? day.focusTask : '‚Äî';

          els.focusTask.value = day.focusTask || '';
          els.notes.value = day.notes || '';
          els.workMinutesGoal.value = state.settings.workMinutesGoal ?? 240;

          renderTodos(day);
          renderHeaderTags();
        };

        const renderTodos = day => {
          els.todoList.innerHTML = '';
          day.todos.forEach(t => {
            const wrap = document.createElement('div');
            wrap.className = 'todoItem';
            wrap.innerHTML = `
        <input type="checkbox" ${t.done ? 'checked' : ''} data-id="${t.id}" />
        <div class="todoText">
          <div class="title">${escapeHtml(t.title)}</div>
          <div class="note">${t.done ? '–≤—ã–ø–æ–ª–Ω–µ–Ω–æ' : '–Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ'}</div>
        </div>
        <button class="miniBtn danger" data-del="${t.id}">–£–¥–∞–ª–∏—Ç—å</button>
      `;
            els.todoList.appendChild(wrap);
          });

          // checkbox listeners
          els.todoList.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', e => {
              const id = e.target.dataset.id;
              const item = day.todos.find(x => x.id === id);
              if (item) {
                item.done = e.target.checked;
                save();
                renderKPIs();
                renderHeaderTags();
                renderTodos(day);
              }
            });
          });

          // delete listeners
          els.todoList.querySelectorAll('button[data-del]').forEach(btn => {
            btn.addEventListener('click', e => {
              const id = e.target.dataset.del;
              day.todos = day.todos.filter(x => x.id !== id);
              save();
              renderKPIs();
              renderHeaderTags();
              renderTodos(day);
            });
          });
        };

        const renderKPIs = () => {
          const iso = todayISO();
          const day = getDay(iso);

          // normalize work minutes to integer
          day.workMinutes = Math.max(0, Math.round(day.workMinutes));

          // streak based on "done"
          const start = state.settings.startDate || '2026-01-14';
          const last30 = getLastNDays(30);
          const doneCount = last30.filter(d => state.days[d] && state.days[d].done).length;

          const streak = calcStreak(start);

          const goal = Number(state.settings.workMinutesGoal) || 240;
          const workMin = Math.round(day.workMinutes);

          // simple "sleep window" score (placeholder)
          // We can't know actual sleep without manual logging; so we score only "plan exists".
          const sleepScore = state.settings.sleepTime && state.settings.wakeTime ? '–ø–ª–∞–Ω –∑–∞–¥–∞–Ω' : '–Ω–µ—Ç –ø–ª–∞–Ω–∞';

          els.kpiStreak.textContent = streak;
          els.kpiDaysDone.textContent = doneCount;
          els.kpiWorkMin.textContent = workMin;
          els.kpiSleepWin.textContent = sleepScore;

          save();
          renderHistory();
        };

        const renderHistory = () => {
          const days = getLastNDays(14).reverse(); // oldest -> newest
          const goal = Number(state.settings.workMinutesGoal) || 240;

          els.history.innerHTML = '';
          days.forEach(iso => {
            const d = state.days[iso];
            const done = d?.done ? true : false;
            const work = Math.round(d?.workMinutes ?? 0);
            const ratio = goal ? Math.round((work / goal) * 100) : 0;

            const cls = done ? 'ok' : 'no';
            const focus = (d?.focusTask || '‚Äî').slice(0, 40);

            const row = document.createElement('div');
            row.className = 'todoItem';
            row.innerHTML = `
        <div class="todoText">
          <div class="title">${dateLabel(iso)} ‚Äî <span class="${cls}">${done ? '–∑–∞—Å—á–∏—Ç–∞–Ω' : '–Ω–µ—Ç'}</span></div>
          <div class="note">–§–æ–∫—É—Å: ${escapeHtml(focus)} ¬∑ –†–∞–±–æ—Ç–∞: ${work}/${goal} –º–∏–Ω (${ratio}%)</div>
        </div>
        <button class="miniBtn ghost" data-open="${iso}">–û—Ç–∫—Ä—ã—Ç—å</button>
      `;
            els.history.appendChild(row);
          });

          els.history.querySelectorAll('button[data-open]').forEach(btn => {
            btn.addEventListener('click', e => {
              const iso = e.target.dataset.open;
              openDayModal(iso);
            });
          });
        };

        const openDayModal = iso => {
          const d = getDay(iso);
          const goal = Number(state.settings.workMinutesGoal) || 240;
          const work = Math.round(d.workMinutes ?? 0);

          const details = [
            `–î–∞—Ç–∞: ${dateLabel(iso)}`,
            `–ó–∞—Å—á–∏—Ç–∞–Ω: ${d.done ? '–¥–∞' : '–Ω–µ—Ç'}`,
            `–§–æ–∫—É—Å: ${d.focusTask || '‚Äî'}`,
            `–†–∞–±–æ—Ç–∞: ${work}/${goal} –º–∏–Ω—É—Ç`,
            `–ß–µ–∫–ª–∏—Å—Ç:`,
            ...d.todos.map(t => ` - [${t.done ? 'x' : ' '}] ${t.title}`),
            `–ó–∞–º–µ—Ç–∫–∏: ${d.notes || '‚Äî'}`,
          ].join('\n');

          alert(details);
        };

        const getLastNDays = n => {
          const out = [];
          const now = new Date();
          for (let i = 0; i < n; i++) {
            const d = new Date(now);
            d.setDate(now.getDate() - i);
            out.push(d.toISOString().slice(0, 10));
          }
          return out;
        };

        const calcStreak = startISO => {
          // streak counts consecutive "done" from today backwards, but not earlier than start date
          const start = new Date(startISO + 'T00:00:00');
          const now = new Date();
          let streak = 0;
          for (let i = 0; i < 365; i++) {
            const d = new Date(now);
            d.setDate(now.getDate() - i);
            if (d < start) break;
            const iso = d.toISOString().slice(0, 10);
            const day = state.days[iso];
            if (day && day.done) {
              streak++;
            } else {
              break;
            }
          }
          return streak;
        };

        const escapeHtml = s =>
          String(s)
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#039;');

        // --- Events ---
        const bind = () => {
          // settings
          els.sleepTime.value = state.settings.sleepTime || '';
          els.wakeTime.value = state.settings.wakeTime || '';
          els.workStartTime.value = state.settings.workStartTime || '';
          els.startDate.value = state.settings.startDate || '2026-01-14';
          els.pomodoroWork.value = state.settings.pomodoroWork ?? 25;
          els.pomodoroBreak.value = state.settings.pomodoroBreak ?? 5;

          els.sleepTime.addEventListener('change', () => {
            state.settings.sleepTime = els.sleepTime.value;
            save();
            renderKPIs();
            renderHeaderTags();
          });
          els.wakeTime.addEventListener('change', () => {
            state.settings.wakeTime = els.wakeTime.value;
            save();
            renderKPIs();
            renderHeaderTags();
          });
          els.workStartTime.addEventListener('change', () => {
            state.settings.workStartTime = els.workStartTime.value;
            save();
            renderToday();
          });
          els.startDate.addEventListener('change', () => {
            state.settings.startDate = els.startDate.value;
            save();
            renderKPIs();
          });

          els.pomodoroWork.addEventListener('change', () => {
            state.settings.pomodoroWork = Number(els.pomodoroWork.value) || 25;
            if (!pom.running) stopPomodoro();
            save();
          });
          els.pomodoroBreak.addEventListener('change', () => {
            state.settings.pomodoroBreak = Number(els.pomodoroBreak.value) || 5;
            save();
          });

          // today fields
          els.focusTask.addEventListener('input', () => {
            const d = getDay(todayISO());
            d.focusTask = els.focusTask.value;
            save();
            renderHeaderTags();
            renderToday();
          });

          els.notes.addEventListener('input', () => {
            const d = getDay(todayISO());
            d.notes = els.notes.value;
            save();
          });

          els.workMinutesGoal.addEventListener('change', () => {
            const v = Math.max(60, Number(els.workMinutesGoal.value) || 240);
            state.settings.workMinutesGoal = v;
            save();
            renderKPIs();
            renderHeaderTags();
          });

          els.addTodoBtn.addEventListener('click', () => {
            const title = (els.newTodoTitle.value || '').trim();
            if (!title) return;
            const d = getDay(todayISO());
            d.todos.unshift({ id: crypto.randomUUID(), title, done: false });
            els.newTodoTitle.value = '';
            save();
            renderTodos(d);
            renderKPIs();
            renderHeaderTags();
          });

          els.copyYesterdayBtn.addEventListener('click', () => {
            const dToday = getDay(todayISO());
            const y = new Date();
            y.setDate(y.getDate() - 1);
            const yISO = y.toISOString().slice(0, 10);
            const dY = state.days[yISO];
            if (!dY) {
              alert('–í—á–µ—Ä–∞—à–Ω–µ–≥–æ –¥–Ω—è –Ω–µ—Ç –≤ –¥–∞–Ω–Ω—ã—Ö.');
              return;
            }
            dToday.todos = dY.todos.map(t => ({ id: crypto.randomUUID(), title: t.title, done: false }));
            save();
            renderTodos(dToday);
            renderKPIs();
            renderHeaderTags();
          });

          els.resetTodayBtn.addEventListener('click', () => {
            if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –¥–Ω—è?')) return;
            const iso = todayISO();
            delete state.days[iso];
            save();
            renderToday();
            renderKPIs();
          });

          // Pomodoro buttons
          els.startPomodoroBtn.addEventListener('click', () => startPomodoro());
          els.pausePomodoroBtn.addEventListener('click', () => pausePomodoro());
          els.stopPomodoroBtn.addEventListener('click', () => stopPomodoro());

          // Mark day done
          els.markDayDoneBtn.addEventListener('click', () => {
            const iso = todayISO();
            const d = getDay(iso);
            const goal = Number(state.settings.workMinutesGoal) || 240;
            const workMin = Math.round(d.workMinutes || 0);

            // "done" criteria: checklist all done OR workMin >= goal
            const allChecked = d.todos.length > 0 && d.todos.every(t => t.done);
            const enoughWork = workMin >= goal;

            const ok = allChecked || enoughWork;
            if (!ok) {
              const msg = [
                '–ü–æ–∫–∞ —Ä–∞–Ω–æ –∑–∞—Å—á–∏—Ç—ã–≤–∞—Ç—å –¥–µ–Ω—å.',
                `–ù—É–∂–Ω–æ –ª–∏–±–æ:`,
                `- –æ—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ –ø—É–Ω–∫—Ç—ã —á–µ–∫–ª–∏—Å—Ç–∞`,
                `- –ª–∏–±–æ –Ω–∞–±—Ä–∞—Ç—å ${goal} –º–∏–Ω—É—Ç —Ä–∞–±–æ—Ç—ã (—Å–µ–π—á–∞—Å ${workMin})`,
              ].join('\n');
              alert(msg);
              return;
            }
            d.done = true;
            d.markedAtISO = new Date().toISOString();
            save();
            renderHeaderTags();
            renderKPIs();
            alert('–î–µ–Ω—å –∑–∞—Å—á–∏—Ç–∞–Ω. –ö—Ä–∞—Å–∞–≤—á–∏–∫.');
          });

          // Export / Import / Clear
          els.exportBtn.addEventListener('click', () => {
            const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'discipline-tracker-export.json';
            a.click();
            URL.revokeObjectURL(a.href);
          });

          els.importBtn.addEventListener('click', () => els.importFile.click());
          els.importFile.addEventListener('change', async () => {
            const file = els.importFile.files?.[0];
            if (!file) return;
            try {
              const text = await file.text();
              const data = JSON.parse(text);
              if (!data || !data.settings || !data.days) throw new Error('bad format');
              state = data;
              save();
              stopPomodoro();
              init();
              alert('–ò–º–ø–æ—Ä—Ç –≥–æ—Ç–æ–≤.');
            } catch (e) {
              alert('–ù–µ —Å–º–æ–≥ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å JSON. –ü—Ä–æ–≤–µ—Ä—å —Ñ–∞–π–ª.');
            } finally {
              els.importFile.value = '';
            }
          });

          els.clearAllBtn.addEventListener('click', () => {
            if (!confirm('–¢–æ—á–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ –¥–Ω–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.')) return;
            localStorage.removeItem(LS_KEY);
            state = defaultState();
            save();
            stopPomodoro();
            init();
          });
        };

        const initPomodoroFromSettings = () => {
          pom.running = false;
          pom.paused = false;
          pom.mode = 'work';
          pom.remainingSec = (Number(state.settings.pomodoroWork) || 25) * 60;
          if (pom.intervalId) clearInterval(pom.intervalId);
          pom.intervalId = setInterval(tickPomodoro, 1000);
          pom.paused = true; // keep paused until Start
          setTimerLabel();
        };

        const init = () => {
          renderToday();
          renderKPIs();
          renderHeaderTags();
          initPomodoroFromSettings();
        };

        bind();
        init();
      })();
    </script>
  </body>
</html>
