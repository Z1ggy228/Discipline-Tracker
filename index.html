<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Discipline Tracker</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#111827; --text:#e5e7eb; --muted:#9ca3af;
      --accent:#60a5fa; --good:#34d399; --bad:#fb7185; --warn:#fbbf24; --line:#243244;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1000px 600px at 20% -10%, rgba(96,165,250,.18), transparent 60%),
                  radial-gradient(900px 500px at 90% 10%, rgba(52,211,153,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:22px;}
    header{
      display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; justify-content:space-between;
      margin-bottom:14px;
    }
    h1{font-size:20px; margin:0; letter-spacing:.2px}
    .sub{color:var(--muted); font-size:13px; margin-top:4px}
    .row{display:grid; grid-template-columns: 1.2fr .8fr; gap:14px;}
    @media (max-width: 980px){ .row{grid-template-columns:1fr; } }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .card h2{font-size:14px; margin:0 0 10px; color:#cbd5e1; font-weight:600}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width: 560px){ .grid2{grid-template-columns:1fr} }
    label{display:block; color:var(--muted); font-size:12px; margin:0 0 6px}
    input[type="time"], input[type="date"], input[type="text"], input[type="number"], textarea{
      width:100%;
      background: rgba(15,23,42,.55);
      border:1px solid rgba(255,255,255,.08);
      color:var(--text);
      padding:10px 10px;
      border-radius: 12px;
      outline:none;
    }
    textarea{min-height:86px; resize:vertical}
    .btns{display:flex; flex-wrap:wrap; gap:8px}
    button{
      background: rgba(96,165,250,.14);
      border:1px solid rgba(96,165,250,.25);
      color:var(--text);
      padding:9px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition: transform .05s ease, background .2s ease;
      font-weight:600;
      font-size:13px;
    }
    button:hover{ background: rgba(96,165,250,.22); }
    button:active{ transform: translateY(1px); }
    .ghost{ background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10); }
    .danger{ background: rgba(251,113,133,.14); border-color: rgba(251,113,133,.30); }
    .good{ background: rgba(52,211,153,.12); border-color: rgba(52,211,153,.25); }
    .tag{
      display:inline-flex; align-items:center; gap:7px;
      padding:7px 10px; border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      font-size:12px;
      color: var(--muted);
    }
    .tag b{color:var(--text); font-weight:800}
    .tags{display:flex; flex-wrap:wrap; gap:8px}
    .hr{height:1px; background: rgba(255,255,255,.08); margin:12px 0}
    .todayHead{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .big{font-size:18px; font-weight:900; letter-spacing:.3px}
    .muted{color:var(--muted)}
    .todoItem{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px; border-radius: 14px;
      background: rgba(15,23,42,.35);
      border:1px solid rgba(255,255,255,.06);
      margin-bottom:8px;
    }
    .todoItem input[type="checkbox"]{transform: translateY(2px); width:18px; height:18px}
    .todoText{flex:1; display:flex; flex-direction:column; gap:3px}
    .todoText .title{font-weight:800; font-size:13px}
    .todoText .note{font-size:12px; color:var(--muted)}
    .miniBtn{
      padding:7px 10px; border-radius:10px; font-size:12px;
      background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.10);
    }
    .kpi{
      display:grid; grid-template-columns: repeat(4, 1fr); gap:10px;
    }
    @media (max-width: 980px){ .kpi{grid-template-columns: repeat(2,1fr);} }
    .kpiBox{
      padding:12px; border-radius: 14px;
      background: rgba(15,23,42,.35);
      border:1px solid rgba(255,255,255,.06);
    }
    .kpiBox .v{font-size:20px; font-weight:900}
    .kpiBox .t{font-size:12px; color:var(--muted); margin-top:3px}
    .pill{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end;}
    .small{font-size:12px; color:var(--muted)}
    .ok{color:var(--good)}
    .no{color:var(--bad)}
    .warn{color:var(--warn)}
    footer{margin-top:14px; color:var(--muted); font-size:12px}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Discipline Tracker</h1>
        <div class="sub">–†–µ–∂–∏–º ‚Üí 1 –∑–∞–¥–∞—á–∞ ‚Üí —Ñ–æ–∫—É—Å-–º–∏–Ω—É—Ç—ã. –í—Å—ë —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ localStorage.</div>
      </div>
      <div class="tags" id="headerTags"></div>
    </header>

    <div class="row">
      <!-- LEFT -->
      <div class="card">
        <div class="todayHead">
          <div>
            <div class="muted" style="font-size:12px;">–î–µ–Ω—å</div>
            <div class="big" id="todayLabel">‚Äî</div>
          </div>
          <div class="pill">
            <span class="tag"><span>–°—Ç–∞—Ä—Ç —Ä–∞–±–æ—Ç—ã:</span> <b id="kWorkStart">‚Äî</b></span>
            <span class="tag"><span>–§–æ–∫—É—Å:</span> <b id="kFocus">‚Äî</b></span>
          </div>
        </div>

        <div class="hr"></div>

        <div class="grid2">
          <div>
            <label for="focusTask">–ì–ª–∞–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ –¥–Ω—è (1 —à—Ç—É–∫–∞)</label>
            <input id="focusTask" type="text" placeholder="–ù–∞–ø—Ä: –¥–æ–¥–µ–ª–∞—Ç—å –∞–¥–∞–ø—Ç–∏–≤ –≤ Tilda" />
          </div>
          <div>
            <label for="workMinutesGoal">–¶–µ–ª—å –ø–æ —Ñ–æ–∫—É—Å—É (–º–∏–Ω—É—Ç—ã)</label>
            <input id="workMinutesGoal" type="number" min="60" step="10" />
            <div class="small" style="margin-top:6px;">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 240 –º–∏–Ω—É—Ç = 4 —á–∞—Å–∞.</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="grid2">
          <div>
            <label for="notes">–ó–∞–º–µ—Ç–∫–∏ (—á—Ç–æ –º–µ—à–∞–ª–æ / —á—Ç–æ –ø–æ–º–æ–≥–ª–æ)</label>
            <textarea id="notes" placeholder="–ö–æ—Ä–æ—Ç–∫–æ: —á—Ç–æ –±—ã–ª–æ —Å–ª–æ–∂–Ω—ã–º, —á—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–ª–æ"></textarea>

            <div class="hr"></div>

            <h2 style="margin:0 0 10px;">–§–æ–∫—É—Å-–≤—Ä–µ–º—è (–≤—Ä—É—á–Ω—É—é)</h2>
            <div class="grid2">
              <div>
                <label for="manualMinutes">–î–æ–±–∞–≤–∏—Ç—å –º–∏–Ω—É—Ç</label>
                <input id="manualMinutes" type="number" min="5" step="5" placeholder="–ù–∞–ø—Ä: 25" />
              </div>
              <div style="display:flex; align-items:flex-end; gap:8px;">
                <button class="good" id="addMinutesBtn" style="width:100%;">–î–æ–±–∞–≤–∏—Ç—å</button>
              </div>
            </div>

            <div class="btns" style="margin-top:10px;">
              <button class="ghost" id="plus25Btn">+25</button>
              <button class="ghost" id="plus50Btn">+50</button>
              <button class="ghost danger" id="minus25Btn">-25</button>
              <button class="ghost danger" id="minus50Btn">-50</button>
            </div>

            <div class="small" style="margin-top:8px;">
              –°–æ–≤–µ—Ç: –æ—Ç—Ä–∞–±–æ—Ç–∞–ª —Ñ–æ–∫—É—Å-—Å–µ—Å—Å–∏—é ‚Äî –Ω–∞–∂–∞–ª <b>+25</b> –∏–ª–∏ <b>+50</b>.
            </div>
          </div>

          <div>
            <h2 style="margin:0 0 10px;">–î–Ω–µ–≤–Ω–æ–π —á–µ–∫–ª–∏—Å—Ç</h2>
            <div id="todoList"></div>

            <div class="grid2" style="margin-top:10px;">
              <div>
                <label for="newTodoTitle">–î–æ–±–∞–≤–∏—Ç—å –ø—É–Ω–∫—Ç</label>
                <input id="newTodoTitle" type="text" placeholder="–ù–∞–ø—Ä: –∞–¥–∞–ø—Ç–∏–≤ 1 —ç–∫—Ä–∞–Ω–∞" />
              </div>
              <div style="display:flex; align-items:flex-end; gap:8px;">
                <button class="good" id="addTodoBtn" style="width:100%;">–î–æ–±–∞–≤–∏—Ç—å</button>
              </div>
            </div>

            <div class="btns" style="margin-top:10px;">
              <button class="ghost" id="copyYesterdayBtn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —á–µ–∫–ª–∏—Å—Ç —Å–æ –≤—á–µ—Ä–∞</button>
              <button class="danger" id="resetTodayBtn">–°–±—Ä–æ—Å–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å</button>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div>
        <div class="card">
          <h2>–†–µ–∂–∏–º</h2>
          <div class="grid2">
            <div>
              <label for="sleepTime">–õ–æ–∂—É—Å—å (–ø–ª–∞–Ω)</label>
              <input id="sleepTime" type="time" />
            </div>
            <div>
              <label for="wakeTime">–í—Å—Ç–∞—é (–ø–ª–∞–Ω)</label>
              <input id="wakeTime" type="time" />
            </div>
            <div>
              <label for="workStartTime">–°–∞–∂—É—Å—å –∑–∞ –∫–æ–º–ø (–ø–ª–∞–Ω)</label>
              <input id="workStartTime" type="time" />
            </div>
            <div>
              <label for="startDate">–°—Ç–∞—Ä—Ç ‚Äú–ø—É—Ç–∏ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã‚Äù</label>
              <input id="startDate" type="date" />
            </div>
          </div>

          <div class="hr"></div>

          <div class="kpi">
            <div class="kpiBox">
              <div class="v" id="kpiStreak">‚Äî</div>
              <div class="t">–°–µ—Ä–∏—è ‚Äú–¥–µ–Ω—å –∑–∞—Å—á–∏—Ç–∞–Ω‚Äù</div>
            </div>
            <div class="kpiBox">
              <div class="v" id="kpiDaysDone">‚Äî</div>
              <div class="t">–ó–∞—Å—á–∏—Ç–∞–Ω–æ –¥–Ω–µ–π (–∑–∞ 30)</div>
            </div>
            <div class="kpiBox">
              <div class="v" id="kpiWorkMin">‚Äî</div>
              <div class="t">–§–æ–∫—É—Å —Å–µ–≥–æ–¥–Ω—è (–º–∏–Ω)</div>
            </div>
            <div class="kpiBox">
              <div class="v" id="kpiSleepPlan">‚Äî</div>
              <div class="t">–ü–ª–∞–Ω —Å–Ω–∞</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="btns">
            <button id="markDayDoneBtn" class="good">–ó–∞—Å—á–∏—Ç–∞—Ç—å –¥–µ–Ω—å</button>
            <button id="exportBtn" class="ghost">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
            <button id="importBtn" class="ghost">–ò–º–ø–æ—Ä—Ç JSON</button>
            <button id="clearAllBtn" class="danger">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
          </div>
          <input id="importFile" type="file" accept="application/json" style="display:none;" />
        </div>

        <div class="card" style="margin-top:14px;">
          <h2>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 14 –¥–Ω–µ–π</h2>
          <div id="history"></div>
        </div>
      </div>
    </div>

    <footer>
      –ú–æ—Ç–∏–≤–∞—Ü–∏—è: –ü—Ö—É–∫–µ—Ç –±–ª–∏–∂–µ –∫–∞–∂–¥—ã–π —Ä–∞–∑, –∫–æ–≥–¥–∞ —Ç—ã —á–µ—Å—Ç–Ω–æ —Ñ–∏–∫—Å–∏—Ä—É–µ—à—å —Ñ–æ–∫—É—Å-–≤—Ä–µ–º—è üå¥
    </footer>
  </div>

<script>
(() => {
  const LS_KEY = "discipline_tracker_v2";

  const $ = (id) => document.getElementById(id);

  // UUID fallback (–±–µ–∑ crypto.randomUUID)
  const uuid = () => (
    "id_" +
    Date.now().toString(16) + "_" +
    Math.random().toString(16).slice(2) + "_" +
    Math.random().toString(16).slice(2)
  );

  const pad2 = (n) => String(n).padStart(2,"0");
  const todayISO = () => new Date().toISOString().slice(0,10);

  const dateLabel = (iso) => {
    const d = new Date(iso + "T00:00:00");
    return d.toLocaleDateString("ru-RU", { weekday:"long", year:"numeric", month:"long", day:"numeric" });
  };

  const defaultState = () => ({
    settings: {
      sleepTime: "00:30",
      wakeTime: "09:00",
      workStartTime: "10:00",
      startDate: "2026-01-14",
      workMinutesGoal: 240
    },
    days: {
      // [iso]: { focusTask, notes, todos:[{id,title,done}], workMinutes:int, done:boolean, markedAtISO }
    }
  });

  const load = () => {
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return defaultState();
      const data = JSON.parse(raw);
      if(!data || typeof data !== "object" || !data.settings || !data.days) return defaultState();
      // migrate minimal fields
      data.settings.workMinutesGoal = Number(data.settings.workMinutesGoal) || 240;
      return data;
    }catch(e){
      return defaultState();
    }
  };

  let state = load();
  const save = () => localStorage.setItem(LS_KEY, JSON.stringify(state));

  const getDay = (iso) => {
    if(!state.days[iso]){
      state.days[iso] = {
        focusTask: "",
        notes: "",
        todos: [
          { id: crypto.randomUUID(), title:"–°–µ–ª –∑–∞ –∫–æ–º–ø –≤–æ–≤—Ä–µ–º—è", done:false },
          { id: crypto.randomUUID(), title:"1 –≥–ª–∞–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ (–¥–≤–∏–≥–∞–ª)", done:false },
          { id: crypto.randomUUID(), title:"240 –º–∏–Ω—É—Ç —Ñ–æ–∫—É—Å–∞ (4 —á–∞—Å–∞)", done:false },
        ],
        workMinutes: 0,
        done: false,
        markedAtISO: ""
      };
      save();
    }
    // ensure int
    state.days[iso].workMinutes = Math.max(0, Number(state.days[iso].workMinutes) || 0);
    state.days[iso].workMinutes = Math.floor(state.days[iso].workMinutes);
    return state.days[iso];
  };

  const escapeHtml = (s) => String(s)
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");

  const els = {
    headerTags: $("headerTags"),
    todayLabel: $("todayLabel"),
    kWorkStart: $("kWorkStart"),
    kFocus: $("kFocus"),

    focusTask: $("focusTask"),
    workMinutesGoal: $("workMinutesGoal"),
    notes: $("notes"),

    manualMinutes: $("manualMinutes"),
    addMinutesBtn: $("addMinutesBtn"),
    plus25Btn: $("plus25Btn"),
    plus50Btn: $("plus50Btn"),
    minus25Btn: $("minus25Btn"),
    minus50Btn: $("minus50Btn"),

    todoList: $("todoList"),
    newTodoTitle: $("newTodoTitle"),
    addTodoBtn: $("addTodoBtn"),
    copyYesterdayBtn: $("copyYesterdayBtn"),
    resetTodayBtn: $("resetTodayBtn"),

    sleepTime: $("sleepTime"),
    wakeTime: $("wakeTime"),
    workStartTime: $("workStartTime"),
    startDate: $("startDate"),

    kpiStreak: $("kpiStreak"),
    kpiDaysDone: $("kpiDaysDone"),
    kpiWorkMin: $("kpiWorkMin"),
    kpiSleepPlan: $("kpiSleepPlan"),

    markDayDoneBtn: $("markDayDoneBtn"),
    exportBtn: $("exportBtn"),
    importBtn: $("importBtn"),
    importFile: $("importFile"),
    clearAllBtn: $("clearAllBtn"),

    history: $("history"),
  };

  const getLastNDays = (n) => {
    const out = [];
    const now = new Date();
    for(let i=0;i<n;i++){
      const d = new Date(now);
      d.setDate(now.getDate() - i);
      out.push(d.toISOString().slice(0,10));
    }
    return out;
  };

  const calcStreak = (startISO) => {
    const start = new Date((startISO || "2026-01-14") + "T00:00:00");
    const now = new Date();
    let streak = 0;
    for(let i=0;i<365;i++){
      const d = new Date(now);
      d.setDate(now.getDate() - i);
      if(d < start) break;
      const iso = d.toISOString().slice(0,10);
      const day = state.days[iso];
      if(day && day.done) streak++;
      else break;
    }
    return streak;
  };

  const renderHeaderTags = () => {
    const iso = todayISO();
    const day = getDay(iso);
    const goal = Number(state.settings.workMinutesGoal) || 240;
    const workMin = Math.floor(day.workMinutes || 0);

    const doneTxt = day.done ? "–¥–µ–Ω—å –∑–∞—Å—á–∏—Ç–∞–Ω" : "–Ω–µ –∑–∞—Å—á–∏—Ç–∞–Ω";
    const doneCls = day.done ? "ok" : "no";

    const ratio = goal ? Math.min(999, Math.round((workMin/goal)*100)) : 0;
    const ratioCls = ratio >= 100 ? "ok" : (ratio >= 60 ? "warn" : "no");

    els.headerTags.innerHTML = `
      <span class="tag"><span>–°–µ–≥–æ–¥–Ω—è:</span> <b class="${doneCls}">${doneTxt}</b></span>
      <span class="tag"><span>–†–∞–±–æ—Ç–∞:</span> <b class="${ratioCls}">${workMin}/${goal} –º–∏–Ω (${ratio}%)</b></span>
      <span class="tag"><span>–†–µ–∂–∏–º:</span> <b>${state.settings.sleepTime} ‚Üí ${state.settings.wakeTime}</b></span>
    `;
  };

  const renderTodos = (day) => {
    els.todoList.innerHTML = "";
    day.todos.forEach((t) => {
      const wrap = document.createElement("div");
      wrap.className = "todoItem";
      wrap.innerHTML = `
        <input type="checkbox" ${t.done ? "checked":""} data-id="${t.id}" />
        <div class="todoText">
          <div class="title">${escapeHtml(t.title)}</div>
          <div class="note">${t.done ? "–≤—ã–ø–æ–ª–Ω–µ–Ω–æ" : "–Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ"}</div>
        </div>
        <button class="miniBtn danger" data-del="${t.id}">–£–¥–∞–ª–∏—Ç—å</button>
      `;
      els.todoList.appendChild(wrap);
    });

    els.todoList.querySelectorAll('input[type="checkbox"]').forEach(cb => {
      cb.addEventListener("change", (e) => {
        const id = e.target.dataset.id;
        const item = day.todos.find(x => x.id === id);
        if(item){
          item.done = e.target.checked;
          save();
          renderKPIs();
          renderHeaderTags();
          renderTodos(day);
        }
      });
    });

    els.todoList.querySelectorAll("button[data-del]").forEach(btn => {
      btn.addEventListener("click", (e) => {
        const id = e.target.dataset.del;
        day.todos = day.todos.filter(x => x.id !== id);
        save();
        renderKPIs();
        renderHeaderTags();
        renderTodos(day);
      });
    });
  };

  const renderToday = () => {
    const iso = todayISO();
    const day = getDay(iso);

    els.todayLabel.textContent = dateLabel(iso);
    els.kWorkStart.textContent = state.settings.workStartTime || "‚Äî";
    els.kFocus.textContent = day.focusTask ? day.focusTask : "‚Äî";

    els.focusTask.value = day.focusTask || "";
    els.notes.value = day.notes || "";
    els.workMinutesGoal.value = Number(state.settings.workMinutesGoal) || 240;

    renderTodos(day);
    renderHeaderTags();
  };

  const renderKPIs = () => {
    const iso = todayISO();
    const day = getDay(iso);

    const last30 = getLastNDays(30);
    const doneCount = last30.filter(d => (state.days[d] && state.days[d].done)).length;

    els.kpiStreak.textContent = calcStreak(state.settings.startDate);
    els.kpiDaysDone.textContent = doneCount;
    els.kpiWorkMin.textContent = Math.floor(day.workMinutes || 0);
    els.kpiSleepPlan.textContent = (state.settings.sleepTime && state.settings.wakeTime)
      ? `${state.settings.sleepTime} ‚Üí ${state.settings.wakeTime}`
      : "‚Äî";

    save();
    renderHistory();
  };

  const renderHistory = () => {
    const days = getLastNDays(14).reverse();
    const goal = Number(state.settings.workMinutesGoal) || 240;

    els.history.innerHTML = "";
    days.forEach(iso => {
      const d = state.days[iso];
      const done = !!d?.done;
      const work = Math.floor(d?.workMinutes ?? 0);
      const ratio = goal ? Math.round((work/goal)*100) : 0;
      const cls = done ? "ok" : "no";
      const focus = (d?.focusTask || "‚Äî").slice(0,40);

      const row = document.createElement("div");
      row.className = "todoItem";
      row.innerHTML = `
        <div class="todoText">
          <div class="title">${escapeHtml(dateLabel(iso))} ‚Äî <span class="${cls}">${done ? "–∑–∞—Å—á–∏—Ç–∞–Ω" : "–Ω–µ—Ç"}</span></div>
          <div class="note">–§–æ–∫—É—Å: ${escapeHtml(focus)} ¬∑ –†–∞–±–æ—Ç–∞: ${work}/${goal} –º–∏–Ω (${ratio}%)</div>
        </div>
        <button class="miniBtn ghost" data-open="${iso}">–û—Ç–∫—Ä—ã—Ç—å</button>
      `;
      els.history.appendChild(row);
    });

    els.history.querySelectorAll("button[data-open]").forEach(btn => {
      btn.addEventListener("click", (e) => {
        const iso = e.target.dataset.open;
        const d = getDay(iso);
        const goal = Number(state.settings.workMinutesGoal) || 240;
        const work = Math.floor(d.workMinutes || 0);

        const details = [
          `–î–∞—Ç–∞: ${dateLabel(iso)}`,
          `–ó–∞—Å—á–∏—Ç–∞–Ω: ${d.done ? "–¥–∞" : "–Ω–µ—Ç"}`,
          `–§–æ–∫—É—Å: ${d.focusTask || "‚Äî"}`,
          `–†–∞–±–æ—Ç–∞: ${work}/${goal} –º–∏–Ω—É—Ç`,
          `–ß–µ–∫–ª–∏—Å—Ç:`,
          ...d.todos.map(t => ` - [${t.done ? "x":" "}] ${t.title}`),
          `–ó–∞–º–µ—Ç–∫–∏: ${d.notes || "‚Äî"}`
        ].join("\n");

        alert(details);
      });
    });
  };

  const addMinutes = (mins) => {
    const iso = todayISO();
    const day = getDay(iso);
    const next = Math.max(0, Math.floor(day.workMinutes || 0) + Math.floor(mins));
    day.workMinutes = next;
    save();
    renderKPIs();
    renderHeaderTags();
  };

  const bind = () => {
    // settings init
    els.sleepTime.value = state.settings.sleepTime || "";
    els.wakeTime.value = state.settings.wakeTime || "";
    els.workStartTime.value = state.settings.workStartTime || "";
    els.startDate.value = state.settings.startDate || "2026-01-14";

    els.sleepTime.addEventListener("change", () => { state.settings.sleepTime = els.sleepTime.value; save(); renderKPIs(); renderHeaderTags(); });
    els.wakeTime.addEventListener("change", () => { state.settings.wakeTime = els.wakeTime.value; save(); renderKPIs(); renderHeaderTags(); });
    els.workStartTime.addEventListener("change", () => { state.settings.workStartTime = els.workStartTime.value; save(); renderToday(); });
    els.startDate.addEventListener("change", () => { state.settings.startDate = els.startDate.value; save(); renderKPIs(); });

    // today fields
    els.focusTask.addEventListener("input", () => {
      const d = getDay(todayISO());
      d.focusTask = els.focusTask.value;
      save();
      renderHeaderTags();
      renderToday();
    });

    els.notes.addEventListener("input", () => {
      const d = getDay(todayISO());
      d.notes = els.notes.value;
      save();
    });

    els.workMinutesGoal.addEventListener("change", () => {
      const v = Math.max(60, Number(els.workMinutesGoal.value) || 240);
      state.settings.workMinutesGoal = v;
      save();
      renderKPIs();
      renderHeaderTags();
    });

    // manual minutes
    els.addMinutesBtn.addEventListener("click", () => {
      const mins = Number(els.manualMinutes.value);
      if(!mins || mins <= 0) return;
      addMinutes(mins);
      els.manualMinutes.value = "";
    });
    els.plus25Btn.addEventListener("click", () => addMinutes(25));
    els.plus50Btn.addEventListener("click", () => addMinutes(50));
    els.minus25Btn.addEventListener("click", () => addMinutes(-25));
    els.minus50Btn.addEventListener("click", () => addMinutes(-50));

    // todos
    els.addTodoBtn.addEventListener("click", () => {
      const title = (els.newTodoTitle.value || "").trim();
      if(!title) return;
      const d = getDay(todayISO());
      d.todos.unshift({ id: crypto.randomUUID(), title, done:false });
      els.newTodoTitle.value = "";
      save();
      renderTodos(d);
      renderKPIs();
      renderHeaderTags();
    });

    els.copyYesterdayBtn.addEventListener("click", () => {
      const dToday = getDay(todayISO());
      const y = new Date();
      y.setDate(y.getDate()-1);
      const yISO = y.toISOString().slice(0,10);
      const dY = state.days[yISO];
      if(!dY){
        alert("–í—á–µ—Ä–∞—à–Ω–µ–≥–æ –¥–Ω—è –Ω–µ—Ç –≤ –¥–∞–Ω–Ω—ã—Ö.");
        return;
      }
      dToday.todos = (dY.todos || []).map(t => ({ id: crypto.randomUUID(), title: t.title, done:false }));
      save();
      renderTodos(dToday);
      renderKPIs();
      renderHeaderTags();
    });

    els.resetTodayBtn.addEventListener("click", () => {
      if(!confirm("–°–±—Ä–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –¥–Ω—è?")) return;
      const iso = todayISO();
      delete state.days[iso];
      save();
      renderToday();
      renderKPIs();
    });

    // mark day done
    els.markDayDoneBtn.addEventListener("click", () => {
      const iso = todayISO();
      const d = getDay(iso);
      const goal = Number(state.settings.workMinutesGoal) || 240;
      const workMin = Math.floor(d.workMinutes || 0);

      const allChecked = d.todos.length > 0 && d.todos.every(t => t.done);
      const enoughWork = workMin >= goal;

      if(!(allChecked || enoughWork)){
        alert(
          `–ü–æ–∫–∞ —Ä–∞–Ω–æ –∑–∞—Å—á–∏—Ç—ã–≤–∞—Ç—å –¥–µ–Ω—å.\n` +
          `–ù—É–∂–Ω–æ –ª–∏–±–æ:\n` +
          `- –æ—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ –ø—É–Ω–∫—Ç—ã —á–µ–∫–ª–∏—Å—Ç–∞\n` +
          `- –ª–∏–±–æ –Ω–∞–±—Ä–∞—Ç—å ${goal} –º–∏–Ω—É—Ç —Ñ–æ–∫—É—Å–∞ (—Å–µ–π—á–∞—Å ${workMin})`
        );
        return;
      }

      d.done = true;
      d.markedAtISO = new Date().toISOString();
      save();
      renderHeaderTags();
      renderKPIs();
      alert("–î–µ–Ω—å –∑–∞—Å—á–∏—Ç–∞–Ω. –¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å.");
    });

    // export/import/clear
    els.exportBtn.addEventListener("click", () => {
      const blob = new Blob([JSON.stringify(state, null, 2)], { type:"application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "discipline-tracker-export.json";
      a.click();
      URL.revokeObjectURL(a.href);
    });

    els.importBtn.addEventListener("click", () => els.importFile.click());
    els.importFile.addEventListener("change", async () => {
      const file = els.importFile.files?.[0];
      if(!file) return;
      try{
        const text = await file.text();
        const data = JSON.parse(text);
        if(!data || !data.settings || !data.days) throw new Error("bad format");
        state = data;
        // normalize
        state.settings.workMinutesGoal = Number(state.settings.workMinutesGoal) || 240;
        save();
        init();
        alert("–ò–º–ø–æ—Ä—Ç –≥–æ—Ç–æ–≤.");
      }catch(e){
        alert("–ù–µ —Å–º–æ–≥ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å JSON. –ü—Ä–æ–≤–µ—Ä—å —Ñ–∞–π–ª.");
      } finally {
        els.importFile.value = "";
      }
    });

    els.clearAllBtn.addEventListener("click", () => {
      if(!confirm("–¢–æ—á–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ –¥–Ω–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.")) return;
      localStorage.removeItem(LS_KEY);
      state = defaultState();
      save();
      init();
    });
  };

  const init = () => {
    renderToday();
    renderKPIs();
    renderHeaderTags();
  };

  bind();
  init();
})();
</script>
</body>
</html>